{% extends "base.html" %}

{% block title %}资产管理{% endblock %}
{% block nav_asset %}active{% endblock %}
{% block container %}
<table id="table_asset" class="table table-striped table-bordered table-hover table-condensed">
    <thead>
        <tr>
            <th>名称(IP)</th>
            <th>操作系统</th>
            <th>架构</th>
            <th>内存</th>
            <th>CPU</th>
            <th>磁盘</th>
            <th>发现时间</th>
            <th>最后发现时间</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<div class="modal fade" id="dialog-dog-asset" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">资源监控</h4>
      </div>
      <div class="modal-body">
         <div id="main" style="width: 850px;height:400px;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
{% endblock %}

{% block js %}

var table = jQuery('#table_asset').DataTable({
    "language": {
        "processing": "处理中...",
        "lengthMenu": "显示 _MENU_ 项结果",
        "zeroRecords": "没有匹配结果",
        "info": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
        "infoEmpty": "显示第 0 至 0 项结果，共 0 项",
        "infoFiltered": "(由 _MAX_ 项结果过滤)",
        "infoPostFix": "",
        "search": "搜索:",
        "searchPlaceholder": "搜索...",
        "url": "",
        "emptyTable": "表中数据为空",
        "loadingRecords": "载入中...",
        "infoThousands": ",",
        "paginate": {
            "first": "首页",
            "previous": "上页",
            "next": "下页",
            "last": "末页"
        },
        "aria": {
            paginate: {
                first: '首页',
                previous: '上页',
                next: '下页',
                last: '末页'
            },
            "sortAscending": ": 以升序排列此列",
            "sortDescending": ": 以降序排列此列"
        },
        "decimal": "-",
        "thousands": "."
    },
    ajax : {
        url : '{% url "asset:list_ajax" %}',
        dataSrc: 'result',
    },
    columns : [
        {
            "data" : function(row, type, set, meta) {
                return row['name'] + '(' + row['ip'] + ')';
            }
        },
        {
            "data" : "os"
        },
        {
            "data" : "arch"
        },
        {
            "data" : "mem"
        },
        {
            "data" : "cpu"
        },
        {
            "data" : "disk"
        },
        {
            "data" : "created_time"
        },
        {
            "data" : "last_time"
        },
        {
            "data" : function(row) {
                return '<a class="btn btn-success btn-xs btn-edit-asset" href="javascript:void(0)" data-id="' + row['id'] + '">编辑</a>' + '<a class="btn btn-primary btn-xs btn-dog-asset" href="javascript:void(0)" data-id="' + row['id'] + '">监控</a>' +
                '<a class="btn btn-danger btn-xs btn-delete-asset" data-id="' + row['id'] + '" href="javascript:void(0)">删除</a>';
            }
        },
    ]
});

jQuery('#table_asset').on('click', '.btn-edit-asset', function() {
    console.log('编辑' + jQuery(this).attr('data-id')); 
    table.ajax.reload(null, false);
});

 //btn-dog-asset
$('#table_asset').on('click', '.btn-dog-asset', function(){
    var char_resource = echarts.init(document.getElementById('main'));
    var id = id = jQuery(this).data('id');
        // 指定图表的配置项和数据
        var chart_resource_option = {
                title: {
                    text: '主机监控'
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data:['CPU','mem']
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                    }
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: []
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                   
                    {
                        name:'CPU',
                        type:'line',
                        stack: 'CPU',
                        data:[]
                    },
                    {
                        name:'mem',
                        type:'line',
                        stack: 'mem',
                        data:[]
                    }
                ]
        };
        $.get('{% url 'asset:resource_ajax' %}',{'id' : id},function(result) {
            if(result['code'] == 200) {
                // 从后端获取数据
                chart_resource_option['xAxis']['data'] = result['result']['xAxis'];
                chart_resource_option['series'][0]['data'] = result['result']['cpu_datas'];
                chart_resource_option['series'][1]['data'] = result['result']['mem_datas'];
                // 使用刚指定的配置项和数据显示图表。
                char_resource.setOption(chart_resource_option);
            }
        }, 'json')
        

$('#dialog-dog-asset').modal({show:true});
});

jQuery('#table_asset').on('click', '.btn-delete-asset', function() {
    console.log('删除' + jQuery(this).attr('data-id')); 
    table.ajax.reload(null, false);
});
{% endblock %}